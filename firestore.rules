rules_version = '2';

/**
 * Firestore Security Rules for SheetMates
 * 
 * Collections:
 * - users: User profiles and settings
 * - parts: Uploaded DXF parts
 * - sheets: Available cutting sheets
 * - orders: Completed orders (write via Cloud Functions only)
 * - pricingConfig: Global pricing configuration
 * - guest_drafts: Ephemeral guest session data
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    /**
     * Check if the request is authenticated
     */
    function isAuth() {
      return request.auth != null;
    }

    /**
     * Check if the authenticated user owns the resource
     */
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    /**
     * Check if the authenticated user has admin role
     */
    function isAdmin() {
      return isAuth() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * Check if a field is not being changed
     */
    function fieldUnchanged(field) {
      return !(field in request.resource.data.diff(resource.data).affectedKeys());
    }

    /**
     * Get the current server timestamp
     */
    function now() {
      return request.time;
    }

    // ============================================
    // Users Collection
    // ============================================

    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own profile (during signup)
      allow create: if isOwner(userId) &&
        // Ensure userId matches the document ID
        request.resource.data.uid == userId &&
        // Cannot self-assign admin role
        (!('role' in request.resource.data) || request.resource.data.role != 'admin');

      // Users can update their own profile (but not role)
      allow update: if isOwner(userId) && fieldUnchanged('role');

      // Only admins can change roles
      allow update: if isAdmin();

      // No deletions (soft delete via status field if needed)
      allow delete: if isAdmin();
    }

    // ============================================
    // Parts Collection
    // ============================================

    match /parts/{partId} {
      // Users can read their own parts, admins can read all
      allow read: if isAuth() && 
        (resource.data.userId == request.auth.uid || isAdmin());

      // Users can create parts for themselves
      allow create: if isAuth() &&
        request.resource.data.userId == request.auth.uid &&
        // Validate required fields
        request.resource.data.keys().hasAll(['userId', 'name', 'createdAt']);

      // Users can update/delete their own parts
      allow update, delete: if isAuth() &&
        (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============================================
    // Sheets Collection
    // ============================================

    match /sheets/{sheetId} {
      // All authenticated users can read available sheets
      allow read: if isAuth();

      // Only admins can create/delete sheets
      allow create, delete: if isAdmin();

      // Sheet locking for concurrent nesting
      allow update: if isAuth() && (
        // Admin override
        isAdmin() ||
        // User can update if they hold the lock
        resource.data.currentLockHolder == request.auth.uid ||
        // Or if the lock is expired/null (acquiring new lock)
        // AND they're setting themselves as the new holder
        (
          (resource.data.lockExpiry == null || resource.data.lockExpiry < now()) &&
          request.resource.data.currentLockHolder == request.auth.uid
        )
      );
    }

    // ============================================
    // Orders Collection
    // ============================================

    match /orders/{orderId} {
      // Users can read their own orders, admins can read all
      allow read: if isAuth() &&
        (resource.data.userId == request.auth.uid || isAdmin());

      // No direct client creates - orders are created via Cloud Functions
      // This prevents price manipulation
      allow create: if false;

      // Only admins can update order status (for production queue)
      allow update: if isAdmin();

      // No deletions
      allow delete: if false;
    }

    // ============================================
    // Pricing Configuration
    // ============================================

    match /pricingConfig/{configId} {
      // Public read access for pricing display
      allow read: if true;

      // Only admins can modify pricing
      allow write: if isAdmin();
    }

    // ============================================
    // Guest Drafts (Ephemeral)
    // ============================================

    match /guest_drafts/{sessionId} {
      // Guest drafts use document-level session ID validation
      // Clients must include their session ID in the document
      // TTL cleanup is handled by Cloud Functions
      allow read: if resource.data.sessionId == sessionId;
      allow create: if request.resource.data.sessionId == sessionId;
      allow update, delete: if resource.data.sessionId == sessionId;
    }

    // ============================================
    // Production Queue (Admin Only)
    // ============================================

    match /production_queue/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // Audit Logs (Admin Read Only)
    // ============================================

    match /audit_logs/{logId} {
      allow read: if isAdmin();
      // Logs are written by Cloud Functions only
      allow write: if false;
    }
  }
}
